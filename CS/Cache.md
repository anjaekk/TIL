# Cache

### 캐시 사용 이유

캐시를 사용하지 않는 경우, 데이터가 변경되지 않았는데도 불구하고 계속 네트워크를 통해 서버에서 데이터를 다운받아야한다. 이렇게 되면 인터넷 네트워크는 느리고 비싸기 때문에 불필요한 자원을 낭비하게 된다. 또한 다운로드로 인한 브라우저 로딩속도도 느려 느린 사용자경험을 제공하게 된다. 

<br/>

### 검증헤더와 조건부 요청

- 검증헤더: 서버 → 클라이언트 에게 전송
    - Last-Modified(데이터의 최종수정일)
    - Etag(고유 버전)
- 조건부 요청: 클라이언트 → 서버로 요청을 보낼 때 조건을 다는 것으로 서버의 데이터 수정일이 요청과 함께 보낸 날짜와 동일한지 서버가 확인할 수 있도록 요청을 보내는 것이다.
    - If-Modified-Since(Last-Modified와 함께 사용)
    - If-None-Match(Etag와 함께 사용)

캐시는 이러한 검증헤더와 조건부 요청을 이용해 캐시 유효기간이 초과하더라도 서버의 데이터가 갱신되지 않으면 별도의 변경되지 않은 데이터(Body)를 제외한 메타정보만 담긴 header를 응답하기 때문에 클라이언트는 캐시에 저장되어있는 데이터를 재활용할 수 있으며 이를 통해 물론 헤더의 내용으로 인한 네트워크 다운로드가 발생하긴 하지만 매우 적은 용량으로 네트워크를 사용할 수 있게 된다.

Last-Modified와 If-Modified-Since는 날짜를 통해 데이터가 변경되었는지 확인하는데 이는 초단위로 밖에 확인할 수 없어 초 미만단위로는 캐시 조정이 불가능하게 된다. 또한 데이터를 수정해서 날짜만 다르고 데이터는 동일한 경우를 걸러낼 수 없게된다. 

하지만 Etag와 If-None-Match는 데이터에 임의의 교유한 버전이름을 달아둠으로써 서버에서 스페이스나 주석처럼 의미가 없다고 생각되는 데이터 변화에 대해서는 신경쓰지 않도록 하는 것처럼 별도의 캐시로직을 관리할 수 있게 된다.(캐시 제어 로직을 서버에서 완전히 관리가능) 데이터가 변경되면 서버가 태그를 변경해 응답하고 클라이언트는 태그 변경사항만 확인하면 된다.

<br/>

### 캐시 프로세스(Last-Modified와 If-Modified-Since 사용시)

1. 클라이언트 요청에 서버에서 캐시에 관한 정보를 헤더로 응답과 함께 반환
- cache-control: max-age=60
    - 60초 동안 캐시가 유효하다.
- Last-Modified: 날짜(검증헤더)
    - 데이터의 최종 수정일
2. 브라우저는 캐시 저장소에 응답결과를 캐시 유효시간인 60초간 검증헤더와 함께 데이터를 저장하게 된다.  
3. 그 후 브라우저는 모든 응답을 보내기전 캐시 저장소를 조회하고 해당 내용이 캐시 저장소에 있으면 저장소에 있는 내용을 먼저 사용하게 된다. 
4. 유효시간인 60초가 지나게 되면 브라우저가 요청을 보낼때 기존 캐시 저장소에서 데이터와 함께 저장되어있던 검증헤더 내용인 **조건부 요청**과 함께 보내게 된다.
- if-modified-since: 날짜
5. 요청을 받은 서버는 조건부 요청과 데이터 최종 수정일을 비교하게 된다.
- 데이터가 변경되었을 경우
    - 새로운 데이터를 전송해준다.
- 데이터가 변경되지 않았을 경우
    - Status code인 304 Not Modified 전송
    - HTTP body 없이 전송(수저된 게 없기 때문에, 헤더만 전송되기 때문에 네트워크 부하가 감소하게 된다.)

<br/>

### Cache-Control
조건부 요청과 관련된 header
- max-age: 캐시 유효시간(초)
- no-cache: 데이터는 캐시해도 되지만, 항상 캐시를 사용하기 전에 프록시 서버가 아닌 원서버(origin)에 If-Modified-Since와 같이 검증 후 사용
- no-store: 데이터에 민간함 정보가 있으므로 저장하면 안됨(메모리에서 사용하고 최대한 빨리 사용) 

<br/>

### 프록시 캐시
프록시 캐시는 응답시간을 줄이기 위해 원서버와 클라이언트 사이에 존재하는 서버이다. 여기서 클라이언트에서 사용하고 저장하는 캐시를 private cache라고 하며 프록시 캐시를 public cache라고 한다. 
![](https://images.velog.io/images/anjaekk/post/015dfdad-4191-4a70-9b9b-97bb3eb1ce04/image.png)
> 📂 [Image Source-wikipedia](https://en.wikipedia.org/wiki/Reverse_proxy)

<br/>

### 캐시 무효화
캐시를 적용하지 않더라도 웹 브라우저들이 임의로 캐시를 저장하기도한다. 그러므로 캐시가 되어선 안되는 부분은 header에 아래의 내용을 모두 넣어 확실히 명시를 해줘야 한다.
- Cache-Control: no-cache, no-store, must-revalidate
- Pragma: no-cache(HTTP 1.0하위 호환문으로 혹시나 모를 하위버전의 경우를 대비하여 함께 넣어준다.)
